



<!doctype html>
<html lang="en" class="no-js">
  <head>
    <!-- BEGIN Kawish's Custom metadata block -->
<!-- Google AdSense -->

      
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-5546856204176740",
    enable_page_level_ads: true
  });
</script>
      

<!-- Google Analytics -->

	  
        
    <script>
    (function(i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function() {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
   
    ga('create', 'UA-143819065-1', 'kawishsiddiqui.com');
    ga('send', 'pageview');
    </script>
	  

<!-- Metadata -->

    <!-- meta description -->
    
     <meta name="description" content="Amazon Redshift WLM Query Monitoring Rule (QMR) Action Notification Utility.">
    
	
    <!-- meta author -->
    
    <!-- meta keywords -->
    
     <meta name="keywords" content="wlm, workload, monitoring, rule, qmr, encrypt, decryption, decrypt, encryption, udf, amazon, function, utility, vacuum, analyze, data lake, datalake, formation, case study, shell, bash, sh, split, size, console, aws, files, tips, cheat, shell command, bash command, script, shell script, sql, teradata, redshift, vba, database, data warehouse, etl, custom, big data">
    

    
    <meta name="robots" content="index, follow">	


      
        <title>Amazon Redshift WLM Query Monitoring Rule (QMR) Action Notification Utility</title>
      

<!-- END Kawish's Custom metadata block -->
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Amazon Redshift WLM Query Monitoring Rule (QMR) Action Notification Utility.">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.0">
    
    
      
        <title>Amazon Redshift WLM Query Monitoring Rule (QMR) Action Notification Utility</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.0284f74d.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-palette.01803549.css">
      
      
        
        
        <meta name="theme-color" content="#3f51b5">
      
    
    
      <script src="../../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../assets/fonts/material-icons.css">
    
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-143819065-1", "kawishsiddiqui.com")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#amazon-redshift-wlm-query-monitoring-rule-qmr-action-notification-utility" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../.." title="Kawish Siddiqui" class="md-header-nav__button md-logo">
          
            <i class="md-icon">î Œ</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic" id="sitename">
            <!--   Kawish Siddiqui -->
				<script> document.getElementById("sitename").innerHTML = window.location.hostname.substr(0, window.location.hostname.indexOf('.')).toUpperCase(); </script></a>
            </span>			
            <span class="md-header-nav__topic">
              
                Amazon Redshift WLM Query Monitoring Rule (QMR) Action Notification Utility
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">		
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>		  
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../../.." title="About Me" class="md-tabs__link">
        About Me
      </a>
    
  </li>

      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../../sh/split_datafile/" title="Blogs" class="md-tabs__link">
          Blogs
        </a>
      
    </li>
  

  

      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../../../cheetsheets/bigdata/hadoop_chtsht/" title="Cheat Sheets" class="md-tabs__link">
          Cheat Sheets
        </a>
      
    </li>
  

  

      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../../../tutorial/redshift/rsintrodwaws/" title="Tutorials" class="md-tabs__link">
          Tutorials
        </a>
      
    </li>
  

  

      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../../../event/reinvent/awsri_2018/" title="Events" class="md-tabs__link">
          Events
        </a>
      
    </li>
  

  

      
    </ul>
  </div>
  
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
		<!--
		<img class="navbar-brand" src="http://www.cutercounter.com/hit.php?id=gqfcck&nd=8&style=148" alt="free counter" border="0"> 
        Start of CuterCounter Code 
		-->
    <script async src='https://cse.google.com/cse.js?cx=partner-pub-5546856204176740:2677115170'></script><div class="gcse-searchbox-only"></div>
	
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../.." title="Kawish Siddiqui" class="md-nav__button md-logo">
      
        <i class="md-icon">î Œ</i>
      
    </a>
    Kawish Siddiqui
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="About Me" class="md-nav__link">
      About Me
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Blogs
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Blogs
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1" type="checkbox" id="nav-2-1">
    
    <label class="md-nav__link" for="nav-2-1">
      Shell/Bash
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-1">
        Shell/Bash
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../sh/split_datafile/" title="Split data file" class="md-nav__link">
      Split data file
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2" type="checkbox" id="nav-2-2">
    
    <label class="md-nav__link" for="nav-2-2">
      VBA
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-2">
        VBA
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../vba/vba_concatif/" title="ConcatIF Function" class="md-nav__link">
      ConcatIF Function
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-3" type="checkbox" id="nav-2-3">
    
    <label class="md-nav__link" for="nav-2-3">
      Teradata
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-3">
        Teradata
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../teradata/td_date_diff/" title="Date Diff Function" class="md-nav__link">
      Date Diff Function
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../teradata/td_turnoff_fallback/" title="Turn off FallBackSetting in Teradata" class="md-nav__link">
      Turn off FallBackSetting in Teradata
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-4" type="checkbox" id="nav-2-4">
    
    <label class="md-nav__link" for="nav-2-4">
      AWS
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-4">
        AWS
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../aws/dl_form_aws/" title="DataLake Formation in AWS" class="md-nav__link">
      DataLake Formation in AWS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-4-2" type="checkbox" id="nav-2-4-2">
    
    <label class="md-nav__link" for="nav-2-4-2">
      Serverless ETL for Amazon Redshift
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-4-2">
        Serverless ETL for Amazon Redshift
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../aws/rssrvlessetl/begsrvlsglueredshift/" title="Beginners" class="md-nav__link">
      Beginners
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../aws/rssrvlessetl/intsrvlsglueredshift/" title="Intermediate" class="md-nav__link">
      Intermediate
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../aws/rssrvlessetl/advsrvlsglueredshift/" title="Advance" class="md-nav__link">
      Advance
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-5" type="checkbox" id="nav-2-5" checked>
    
    <label class="md-nav__link" for="nav-2-5">
      Redshift
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-5">
        Redshift
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../encrypt_decrypt_udf_using_pyaes/" title="Redshift Encryption UDF" class="md-nav__link">
      Redshift Encryption UDF
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Redshift QMR Notification Utility
      </label>
    
    <a href="./" title="Redshift QMR Notification Utility" class="md-nav__link md-nav__link--active">
      Redshift QMR Notification Utility
    </a>
    
      
<nav class="md-nav md-nav--secondary">


   <div class="a2a_kit">
       <a id="fblike" class="a2a_button_facebook_like" data-action="recommend" data-href="https://kawishsiddiqui.com/" data-layout="box_count" data-width="55"></a>
   </div>
   <script async src="https://static.addtoany.com/menu/page.js"></script>



      
            <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
            <!-- kawishsiddiqui TOC -->
            <ins class="adsbygoogle"
                 style="border:none;display:inline-block;width:200px;height:100px"
                 data-ad-client="ca-pub-5546856204176740"
                 data-ad-slot="1250189729"
			 > </ins>
            <script>
                 (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
      

  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#goals" title="Goals" class="md-nav__link">
    Goals
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installation-notes" title="Installation Notes:" class="md-nav__link">
    Installation Notes:
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites" title="Prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installation-from-cloudformation-template" title="Installation from CloudFormation Template:" class="md-nav__link">
    Installation from CloudFormation Template:
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-navigate-to-the-qmrnotificationutilitys-directory-within-the-amazon-redshift-utils-project" title="1. Navigate to the QMRNotificationUtility's directory within the amazon-redshift-utils project:" class="md-nav__link">
    1. Navigate to the QMRNotificationUtility's directory within the amazon-redshift-utils project:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-copy-the-zipped-python-deployment-package-for-the-lambda-function-to-a-location-of-your-choosing-in-s3" title="2. Copy the zipped python Deployment Package for the Lambda function to a location of your choosing in S3:" class="md-nav__link">
    2. Copy the zipped python Deployment Package for the Lambda function to a location of your choosing in S3:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-gather-the-necessary-identifiers-noted-in-the-prerequistes-section-above" title="3. Gather the necessary identifiers noted in the prerequistes section above:" class="md-nav__link">
    3. Gather the necessary identifiers noted in the prerequistes section above:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-create-the-lambda-function" title="4. Create the Lambda Function" class="md-nav__link">
    4. Create the Lambda Function
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-verify-creation-is-complete" title="5. Verify creation is complete" class="md-nav__link">
    5. Verify creation is complete
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-add-an-encrypted-password" title="6. Add an encrypted password" class="md-nav__link">
    6. Add an encrypted password
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-update-your-cloudformation-stack" title="7. Update your CloudFormation stack" class="md-nav__link">
    7. Update your CloudFormation stack
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-verify-the-modification-is-complete" title="8. Verify the modification is complete" class="md-nav__link">
    8. Verify the modification is complete
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9-check-the-inbox-of-the-email-address-you-included-for-snsemailparameter" title="9. Check the inbox of the email address you included for SNSEmailParameter." class="md-nav__link">
    9. Check the inbox of the email address you included for SNSEmailParameter.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#10-verify-the-email-address-receives-an-email-notification-within-5-minutes" title="10. Verify the email address receives an email notification within 5 minutes" class="md-nav__link">
    10. Verify the email address receives an email notification within 5 minutes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rebuilding-lambda-function" title="Rebuilding Lambda Function" class="md-nav__link">
    Rebuilding Lambda Function
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Vacclyze/" title="Redshift Vacuum Analyze" class="md-nav__link">
      Redshift Vacuum Analyze
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../awslabs_SystemTablePersistence/" title="System Table Persistence" class="md-nav__link">
      System Table Persistence
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../second_level/" title="Second Level" class="md-nav__link">
      Second Level
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Cheat Sheets
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Cheat Sheets
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-1" type="checkbox" id="nav-3-1">
    
    <label class="md-nav__link" for="nav-3-1">
      Big Data
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-1">
        Big Data
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../cheetsheets/bigdata/hadoop_chtsht/" title="Hadoop" class="md-nav__link">
      Hadoop
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../cheetsheets/bigdata/pig_chtsht/" title="PIG" class="md-nav__link">
      PIG
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../cheetsheets/bigdata/htrn_chtsht/" title="Hortron" class="md-nav__link">
      Hortron
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../cheetsheets/bigdata/casestudies/" title="Case Studies" class="md-nav__link">
      Case Studies
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Tutorials
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Tutorials
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-1" type="checkbox" id="nav-4-1">
    
    <label class="md-nav__link" for="nav-4-1">
      Redshift
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-1">
        Redshift
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../tutorial/redshift/rsintrodwaws/" title="Introduction to Data Warehouse in AWS" class="md-nav__link">
      Introduction to Data Warehouse in AWS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../tutorial/redshift/rsmoderndwaws/" title="Modernize Your Data Warehouse in AWS" class="md-nav__link">
      Modernize Your Data Warehouse in AWS
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Events
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Events
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-1" type="checkbox" id="nav-5-1">
    
    <label class="md-nav__link" for="nav-5-1">
      AWS
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-1">
        AWS
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../event/reinvent/awsri_2018/" title="re-Invent 2018" class="md-nav__link">
      re-Invent 2018
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../event/reinvent/awsri_2019/" title="re-Invent 2019" class="md-nav__link">
      re-Invent 2019
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">


   <div class="a2a_kit">
       <a id="fblike" class="a2a_button_facebook_like" data-action="recommend" data-href="https://kawishsiddiqui.com/" data-layout="box_count" data-width="55"></a>
   </div>
   <script async src="https://static.addtoany.com/menu/page.js"></script>



      
            <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
            <!-- kawishsiddiqui TOC -->
            <ins class="adsbygoogle"
                 style="border:none;display:inline-block;width:200px;height:100px"
                 data-ad-client="ca-pub-5546856204176740"
                 data-ad-slot="1250189729"
			 > </ins>
            <script>
                 (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
      

  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#goals" title="Goals" class="md-nav__link">
    Goals
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#installation-notes" title="Installation Notes:" class="md-nav__link">
    Installation Notes:
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#prerequisites" title="Prerequisites" class="md-nav__link">
    Prerequisites
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#installation-from-cloudformation-template" title="Installation from CloudFormation Template:" class="md-nav__link">
    Installation from CloudFormation Template:
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-navigate-to-the-qmrnotificationutilitys-directory-within-the-amazon-redshift-utils-project" title="1. Navigate to the QMRNotificationUtility's directory within the amazon-redshift-utils project:" class="md-nav__link">
    1. Navigate to the QMRNotificationUtility's directory within the amazon-redshift-utils project:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-copy-the-zipped-python-deployment-package-for-the-lambda-function-to-a-location-of-your-choosing-in-s3" title="2. Copy the zipped python Deployment Package for the Lambda function to a location of your choosing in S3:" class="md-nav__link">
    2. Copy the zipped python Deployment Package for the Lambda function to a location of your choosing in S3:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-gather-the-necessary-identifiers-noted-in-the-prerequistes-section-above" title="3. Gather the necessary identifiers noted in the prerequistes section above:" class="md-nav__link">
    3. Gather the necessary identifiers noted in the prerequistes section above:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-create-the-lambda-function" title="4. Create the Lambda Function" class="md-nav__link">
    4. Create the Lambda Function
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-verify-creation-is-complete" title="5. Verify creation is complete" class="md-nav__link">
    5. Verify creation is complete
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-add-an-encrypted-password" title="6. Add an encrypted password" class="md-nav__link">
    6. Add an encrypted password
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#7-update-your-cloudformation-stack" title="7. Update your CloudFormation stack" class="md-nav__link">
    7. Update your CloudFormation stack
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#8-verify-the-modification-is-complete" title="8. Verify the modification is complete" class="md-nav__link">
    8. Verify the modification is complete
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#9-check-the-inbox-of-the-email-address-you-included-for-snsemailparameter" title="9. Check the inbox of the email address you included for SNSEmailParameter." class="md-nav__link">
    9. Check the inbox of the email address you included for SNSEmailParameter.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#10-verify-the-email-address-receives-an-email-notification-within-5-minutes" title="10. Verify the email address receives an email notification within 5 minutes" class="md-nav__link">
    10. Verify the email address receives an email notification within 5 minutes
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#rebuilding-lambda-function" title="Rebuilding Lambda Function" class="md-nav__link">
    Rebuilding Lambda Function
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
				<!-- BEGIN Ad -->
				
				      
				<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
				<ins class="adsbygoogle"
				     style="display:block;height:100px"
				     data-ad-layout="in-article"
				     data-ad-format="fluid"
				     data-ad-client="ca-pub-5546856204176740"
				     data-ad-slot="5536919095"></ins>
				<script>
				     (adsbygoogle = window.adsbygoogle || []).push({});
				</script>
				      
				
				<!-- END Ad -->
				
                <h1 id="amazon-redshift-wlm-query-monitoring-rule-qmr-action-notification-utility">Amazon Redshift WLM Query Monitoring Rule (QMR) Action Notification Utility</h1>
<h2 id="goals">Goals</h2>
<p>This utility uses a scheduled Lambda function to pull records from the QMR action system log table (<code>stl_wlm_rule_action</code>) and publish them to an SNS topic. This utility can be used to send periodic notifications based on the WLM query monitoring rule actions taken for your unique workload and rules configuration.</p>
<p>In Amazon Redshift workload management (WLM), query monitoring rules define metrics-based performance boundaries for WLM queues and specify what action to take when a query goes beyond those boundaries. For example, for a queue dedicated to short running queries, you might create a rule that aborts queries that run for more than 60 seconds. To track poorly designed queries, you might have another rule that logs queries that contain nested loops.  The rule actions are captured in <code>stl_wlm_rule_action</code> system table. For more information about Redshift workload management (WLM) query monitoring rules and how to configure it, please refer to Redshift <a href="http://docs.aws.amazon.com/redshift/latest/mgmt/workload-mgmt-config.html">Documentation</a></p>
<p>The utility periodically scans <code>stl_wlm_rule_action.actions</code> (log/hop/abort) recorded by WLM query monitoring rules and sends the records as SNS notifications. In summary, a Lambda function is invoked on a scheduled interval, connects to your Redshift cluster, reads events from <code>stl_wlm_rule_action</code> and publishes them to an SNS topic as a JSON string.</p>
<h2 id="installation-notes">Installation Notes:</h2>
<h3 id="prerequisites">Prerequisites</h3>
<p>This utility requires the following items:</p>
<ul>
<li>
<p>VPC: A VPC which currently contains your Amazon Redshift resource and will contain this utility&rsquo;s Lambda function. <strong><em>NOTE: VPC ID</em></strong></p>
</li>
<li>
<p>Private Subnets with NAT route: At least two private subnets within that VPC with private routes to the target Amazon Redshift cluster. You should have a NAT Gateway to give access to the Internet for those subnets&rsquo; routing tables. You cannot use public subnets. You can read more information on this Lambda requirement here: <a href="https://aws.amazon.com/blogs/aws/new-access-resources-in-a-vpc-from-your-lambda-functions/">AWS blog</a>. <strong><em>NOTE: Subnet IDs</em></strong></p>
</li>
<li>
<p>Security Group: A VPC security group which allows the Lambda function access to your Amazon Redshift cluster on the port specified for SQL connections. <strong><em>NOTE: VPC Security Group ID</em></strong></p>
</li>
<li>
<p>An Amazon Redshift cluster in the above VPC. <strong><em>NOTE: Amazon Redshift cluster&rsquo;s Endpoint, Port, Database</em></strong></p>
</li>
<li>
<p>Database user credentials for an Amazon Redshift user with access to <a href="http://docs.aws.amazon.com/redshift/latest/dg/r_STL_WLM_RULE_ACTION.html"><code>STL_WLM_RULE_ACTION</code></a>. A superuser will be able to see all rows in this table, and a non-privileged user will be able to see only their own rows. More on visibility here: <a href="http://docs.aws.amazon.com/redshift/latest/dg/c_visibility-of-data.html">Visibility of Data in System Tables and Views</a>. <strong><em>NOTE: Amazon Redshift cluster&rsquo;s user name and password</em></strong></p>
</li>
<li>
<p>An active WLM configuration with QMR enabled (<a href="http://docs.aws.amazon.com/redshift/latest/mgmt/workload-mgmt-config.html">Documentation</a>).</p>
</li>
<li>
<p>Access to an IAM user with privileges to create and modify the necessary CloudFormation, KMS, IAM, SNS, and CloudWatch Events resources.</p>
</li>
<li>
<p>A locally cloned amazon-redshift-utils project containing this utility and AWS CLI and/or AWS Console access. </p>
</li>
</ul>
<h3 id="installation-from-cloudformation-template">Installation from CloudFormation Template:</h3>
<p>The quickest way to get up and running with the QMRNotificationUtility is by leveraging the packaged CloudFormation template and the AWS CLI.</p>
<h4 id="1-navigate-to-the-qmrnotificationutilitys-directory-within-the-amazon-redshift-utils-project">1. Navigate to the QMRNotificationUtility&rsquo;s directory within the amazon-redshift-utils project:</h4>
<pre><code>git clone/pull amazon-redshift-utils
cd amazon-redshift-utils/src/QMRNotificationUtility
</code></pre>

<h4 id="2-copy-the-zipped-python-deployment-package-for-the-lambda-function-to-a-location-of-your-choosing-in-s3">2. Copy the zipped python Deployment Package for the Lambda function to a location of your choosing in S3:</h4>
<pre><code class="bash">aws s3 cp ./lambda/dist/qmr-action-notification-utility-1.4.zip s3://yourbucket/qmr-action-notification-utility-1.4.zip
</code></pre>

<h4 id="3-gather-the-necessary-identifiers-noted-in-the-prerequistes-section-above">3. Gather the necessary identifiers noted in the prerequistes section above:</h4>
<ul>
<li>VPC ID</li>
<li>Subnet ID(s)</li>
<li>Security Group ID(s)</li>
<li>Cluster Endpoint</li>
<li>Cluster Port</li>
<li>Cluster Database</li>
<li>Cluster Credentials (Username and Password)</li>
<li>Bucket to host the Lambda Deployment Package</li>
<li>Email address to be notified of WLM actions</li>
</ul>
<h4 id="4-create-the-lambda-function">4. Create the Lambda Function</h4>
<p>Use the AWS CLI to create a stack containing the necessary dependencies and Lambda function:</p>
<pre><code class="bash">aws cloudformation create-stack \
--stack-name qmr-action-notification-utility \
--template-body file://./cloudformation/qmr-action-notification-utility.yaml \
--parameters \
  ParameterKey=S3Bucket,ParameterValue=yourbucket \
  ParameterKey=S3Key,ParameterValue=qmr-action-notification-utility-1.4.zip \
  ParameterKey=SNSEmailParameter,ParameterValue=test@email.com \
  ParameterKey=VPC,ParameterValue=vpc-abcd1234 \
  ParameterKey=SubnetIds,ParameterValue=subnet-abcd1234 \
  ParameterKey=SecurityGroupIds,ParameterValue=sg-abcd1234 \
  ParameterKey=RedshiftMonitoringUser,ParameterValue=monitoring_user \
  ParameterKey=RedshiftClusterPort,ParameterValue=cluster_port \
  ParameterKey=RedshiftClusterEndpoint,ParameterValue=examplecluster.abcd12340987.us-east-1.redshift.amazonaws.com \
  ParameterKey=RedshiftClusterDatabase,ParameterValue=db_name \
  ParameterKey=MonitoringDBPasswordCiphertext,ParameterValue= \
--capabilities CAPABILITY_IAM
</code></pre>

<h4 id="5-verify-creation-is-complete">5. Verify creation is complete</h4>
<p>It may take a few mintues for the stack&rsquo;s resources to be provisioned, and is completed when the following command returns &ldquo;CREATE_COMPLETE&rdquo;:</p>
<pre><code class="bash">aws cloudformation describe-stacks --stack-name qmr-action-notification-utility --query 'Stacks[0].StackStatus' --output text
</code></pre>

<h4 id="6-add-an-encrypted-password">6. Add an encrypted password</h4>
<p>From the completed stack creation, extract the KMS Key ID, and use that Key to process your plaintext database password to ciphertext:</p>
<pre><code class="bash"># Extract KMS Key ID
KMSKEYID=`aws cloudformation describe-stack-resource --stack-name qmr-action-notification-utility --logical-resource-id RedshiftKMSKey --query 'StackResourceDetail.PhysicalResourceId' --output text`
# Generate a read restricted local file to store your plaintext password
(umask 077; touch passwd.txt)
# Insert your plaintext password into file. If using vi ensure binary mode and no automatic EOL
vi -b -c 'set noeol' passwd.txt
# Read plaintext password file contents into kms encrypt to generate ciphertext
CIPHERTEXT=`aws kms encrypt --key-id $KMSKEYID --plaintext file://./passwd.txt --query 'CiphertextBlob' --output text`
# Cleanup password file
rm passwd.txt
</code></pre>

<h4 id="7-update-your-cloudformation-stack">7. Update your CloudFormation stack</h4>
<p>Add the <code>MonitoringDBPasswordCiphertext</code> parameter with the ciphertext generated from the previous step, leaving all other parameters unchanged:</p>
<pre><code class="bash">aws cloudformation update-stack \
--stack-name qmr-action-notification-utility \
--use-previous-template \
--parameters \
  ParameterKey=MonitoringDBPasswordCiphertext,ParameterValue=$CIPHERTEXT \
  ParameterKey=S3Bucket,UsePreviousValue=true \
  ParameterKey=S3Key,UsePreviousValue=true \
  ParameterKey=SNSEmailParameter,UsePreviousValue=true \ 
  ParameterKey=VPC,UsePreviousValue=true \
  ParameterKey=SubnetIds,UsePreviousValue=true \
  ParameterKey=SecurityGroupIds,UsePreviousValue=true \
  ParameterKey=RedshiftMonitoringUser,UsePreviousValue=true \
  ParameterKey=RedshiftClusterPort,UsePreviousValue=true \
  ParameterKey=RedshiftClusterEndpoint,UsePreviousValue=true \
  ParameterKey=RedshiftClusterDatabase,UsePreviousValue=true \
--capabilities CAPABILITY_IAM
</code></pre>

<h4 id="8-verify-the-modification-is-complete">8. Verify the modification is complete</h4>
<p>It may take a moment for the stack&rsquo;s resources to be updated, and is done when the following command returns &ldquo;UPDATE_COMPLETE&rdquo;:</p>
<pre><code class="bash">aws cloudformation describe-stacks --stack-name qmr-action-notification-utility --query 'Stacks[0].StackStatus' --output text
</code></pre>

<h4 id="9-check-the-inbox-of-the-email-address-you-included-for-snsemailparameter">9. Check the inbox of the email address you included for SNSEmailParameter.</h4>
<p>There should be an &ldquo;AWS Notification - Subscription Confirmation&rdquo; from no-reply@sns.amazonaws.com asking that you confirm your subscription. Click the link if you wish to receive updates on this email address.  </p>
<h4 id="10-verify-the-email-address-receives-an-email-notification-within-5-minutes">10. Verify the email address receives an email notification within 5 minutes</h4>
<p>By purposely triggering a QMR action by manually running SQL that is known to violate a rule defined in your active WLM configuration. Below is one example SNS notification email message:</p>
<pre><code class="json">[
  {
     &quot;clusterid&quot;:&quot;examplecluster&quot;,
     &quot;database&quot;:&quot;dev&quot;,
     &quot;userid&quot;:100,
     &quot;query&quot;:1186777,
     &quot;service_class&quot;:6,
     &quot;rule&quot;:&quot;Rule1_Nested_Loop&quot;,
     &quot;action&quot;:&quot;abort&quot;,
     &quot;recordtime&quot;:&quot;2017-06-12T06:51:57.167052&quot;
  },
  {
      &quot;clusterid&quot;:&quot;examplecluster&quot;,
      &quot;database&quot;:&quot;dev&quot;,
      &quot;userid&quot;:100,
      &quot;query&quot;:1186999,
      &quot;service_class&quot;:6,
      &quot;rule&quot;:&quot;Rule2_high_Return_Rows&quot;,
      &quot;action&quot;:&quot;log&quot;,
      &quot;recordtime&quot;:&quot;2017-06-12T06:53:48.935375&quot;
   }
]
</code></pre>

<h3 id="rebuilding-lambda-function">Rebuilding Lambda Function</h3>
<p>If you wish to rebuild the Lambda function yourself, you can use <code>lambda/build.sh</code> to create a zipped Deployment Package to upload to your S3 bucket. This utility requires <code>pip</code> and <code>virtualenv</code> python dependencies. This script will initialize a transient virtual environment, download python dependencies from <code>requirements.txt</code>, and zip the lambda function source code with dependencies into a versioned archive for uploading to S3.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">

					   


  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        [ &copy; <script> document.write("<a href='" + window.location.href +"'>" + window.location.hostname + "</a> ] "); </script>
        
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/ksiddiqui79" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/iamkawish" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://linkedin.com/in/kawish" class="md-footer-social__link fa fa-linkedin"></a>
    
  <img src="https://smallseotools.com/counterDisplay?code=ab8260dea84197452b9dfab712d575f6&style=0003&pad=8&type=page&initCount=620" alt="counter for traffic" width="100" height="15" border="0">
	
  </div>

	  
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.245445c6.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script>
      
    

<div class="a2a_kit a2a_floating_style a2a_vertical_style" style="right:20px; bottom:20px;">
    <a class="a2a_button_facebook"></a>
    <a class="a2a_button_twitter"></a>
    <a class="a2a_button_linkedin"></a>
    <a class="a2a_button_whatsapp"></a>
    <a class="a2a_button_email"></a>
    <a class="a2a_dd" href="https://www.addtoany.com/share"></a>
</div>

<script async src="https://static.addtoany.com/menu/page.js"></script>
  </body>
</html>