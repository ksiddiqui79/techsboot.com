



<!doctype html>
<html lang="en" class="no-js">
  <head>
    <!-- BEGIN Kawish's Custom metadata block -->
<!-- Google AdSense -->

      
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-5546856204176740",
    enable_page_level_ads: true
  });
</script>
      

<!-- Google Analytics -->

	  
        
    <script>
    (function(i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function() {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
   
    ga('create', 'UA-143819065-1', 'kawishsiddiqui.com');
    ga('send', 'pageview');
    </script>
	  

<!-- Metadata -->

    <!-- meta description -->
    
     <meta name="description" content="Amazon Redshift System Object Persistence Utility.">
    
	
    <!-- meta author -->
    
    <!-- meta keywords -->
    
     <meta name="keywords" content="utility, vacuum, analyze, data lake, datalake, formation, case study, shell, bash, sh, split, size, console, aws, files, tips, cheat, shell command, bash command, script, shell script, sql, teradata, redshift, vba, database, data warehouse, etl, custom, big data">
    

    
    <meta name="robots" content="index, follow">	


      
        <title>Amazon Redshift System Object Persistence Utility</title>
      

<!-- END Kawish's Custom metadata block -->
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Amazon Redshift System Object Persistence Utility.">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.0">
    
    
      
        <title>Amazon Redshift System Object Persistence Utility</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/application.0284f74d.css">
      
        <link rel="stylesheet" href="../../../assets/stylesheets/application-palette.01803549.css">
      
      
        
        
        <meta name="theme-color" content="#3f51b5">
      
    
    
      <script src="../../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../../assets/fonts/material-icons.css">
    
    
    
      
        
<script>
  window.ga = window.ga || function() {
    (ga.q = ga.q || []).push(arguments)
  }
  ga.l = +new Date
  /* Setup integration and send page view */
  ga("create", "UA-143819065-1", "kawishsiddiqui.com")
  ga("set", "anonymizeIp", true)
  ga("send", "pageview")
  /* Register handler to log search on blur */
  document.addEventListener("DOMContentLoaded", () => {
    if (document.forms.search) {
      var query = document.forms.search.query
      query.addEventListener("blur", function() {
        if (this.value) {
          var path = document.location.pathname;
          ga("send", "pageview", path + "?q=" + this.value)
        }
      })
    }
  })
</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
      
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#amazon-redshift-system-object-persistence-utility" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="../../.." title="Kawish Siddiqui" class="md-header-nav__button md-logo">
          
            <i class="md-icon"></i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            <span class="md-header-nav__topic" id="sitename">
            <!--   Kawish Siddiqui -->
				<script> document.getElementById("sitename").innerHTML = window.location.hostname.substr(0, window.location.hostname.indexOf('.')).toUpperCase(); </script></a>
            </span>			
            <span class="md-header-nav__topic">
              
                Amazon Redshift System Object Persistence Utility
              
            </span>
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">		
        
          <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
          
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>		  
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../../.." title="About Me" class="md-tabs__link">
        About Me
      </a>
    
  </li>

      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../../sh/split_datafile/" title="Blogs" class="md-tabs__link">
          Blogs
        </a>
      
    </li>
  

  

      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../../../cheetsheets/bigdata/hadoop_chtsht/" title="Cheat Sheets" class="md-tabs__link">
          Cheat Sheets
        </a>
      
    </li>
  

  

      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../../../tutorial/redshift/rsintrodwaws/" title="Tutorials" class="md-tabs__link">
          Tutorials
        </a>
      
    </li>
  

  

      
        
  
  
    
    
  
  
    <li class="md-tabs__item">
      
        <a href="../../../event/reinvent/awsri_2018/" title="Events" class="md-tabs__link">
          Events
        </a>
      
    </li>
  

  

      
    </ul>
  </div>
  
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
		<!--
		<img class="navbar-brand" src="http://www.cutercounter.com/hit.php?id=gqfcck&nd=8&style=148" alt="free counter" border="0"> 
        Start of CuterCounter Code 
		-->
    <script async src='https://cse.google.com/cse.js?cx=partner-pub-5546856204176740:2677115170'></script><div class="gcse-searchbox-only"></div>
	
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="../../.." title="Kawish Siddiqui" class="md-nav__button md-logo">
      
        <i class="md-icon"></i>
      
    </a>
    Kawish Siddiqui
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../../.." title="About Me" class="md-nav__link">
      About Me
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2" type="checkbox" id="nav-2" checked>
    
    <label class="md-nav__link" for="nav-2">
      Blogs
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-2">
        Blogs
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-1" type="checkbox" id="nav-2-1">
    
    <label class="md-nav__link" for="nav-2-1">
      Shell/Bash
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-1">
        Shell/Bash
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../sh/split_datafile/" title="Split data file" class="md-nav__link">
      Split data file
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-2" type="checkbox" id="nav-2-2">
    
    <label class="md-nav__link" for="nav-2-2">
      VBA
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-2">
        VBA
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../vba/vba_concatif/" title="ConcatIF Function" class="md-nav__link">
      ConcatIF Function
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-3" type="checkbox" id="nav-2-3">
    
    <label class="md-nav__link" for="nav-2-3">
      Teradata
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-3">
        Teradata
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../teradata/td_date_diff/" title="Date Diff Function" class="md-nav__link">
      Date Diff Function
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../teradata/td_turnoff_fallback/" title="Turn off FallBackSetting in Teradata" class="md-nav__link">
      Turn off FallBackSetting in Teradata
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-4" type="checkbox" id="nav-2-4">
    
    <label class="md-nav__link" for="nav-2-4">
      AWS
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-4">
        AWS
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../aws/dl_form_aws/" title="DataLake Formation in AWS" class="md-nav__link">
      DataLake Formation in AWS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-4-2" type="checkbox" id="nav-2-4-2">
    
    <label class="md-nav__link" for="nav-2-4-2">
      Serverless ETL for Amazon Redshift
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="3">
      <label class="md-nav__title" for="nav-2-4-2">
        Serverless ETL for Amazon Redshift
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../aws/rssrvlessetl/begsrvlsglueredshift/" title="Beginners" class="md-nav__link">
      Beginners
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../aws/rssrvlessetl/intsrvlsglueredshift/" title="Intermediate" class="md-nav__link">
      Intermediate
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../aws/rssrvlessetl/advsrvlsglueredshift/" title="Advance" class="md-nav__link">
      Advance
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-2-5" type="checkbox" id="nav-2-5" checked>
    
    <label class="md-nav__link" for="nav-2-5">
      Redshift
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-2-5">
        Redshift
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../encrypt_decrypt_udf_using_pyaes/" title="Redshift Encryption UDF" class="md-nav__link">
      Redshift Encryption UDF
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../RedshiftQMRActvtMon/" title="Redshift QMR Notification Utility" class="md-nav__link">
      Redshift QMR Notification Utility
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../Vacclyze/" title="Redshift Vacuum Analyze" class="md-nav__link">
      Redshift Vacuum Analyze
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        System Table Persistence
      </label>
    
    <a href="./" title="System Table Persistence" class="md-nav__link md-nav__link--active">
      System Table Persistence
    </a>
    
      
<nav class="md-nav md-nav--secondary">


   <div class="a2a_kit">
       <a id="fblike" class="a2a_button_facebook_like" data-action="recommend" data-href="https://kawishsiddiqui.com/" data-layout="box_count" data-width="55"></a>
   </div>
   <script async src="https://static.addtoany.com/menu/page.js"></script>



      
            <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
            <!-- kawishsiddiqui TOC -->
            <ins class="adsbygoogle"
                 style="border:none;display:inline-block;width:200px;height:100px"
                 data-ad-client="ca-pub-5546856204176740"
                 data-ad-slot="1250189729"
			 > </ins>
            <script>
                 (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
      

  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#deploying" title="Deploying" class="md-nav__link">
    Deploying
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#manual-setup-actions-optional-if-you-are-using-the-above-lambda-function" title="Manual Setup Actions (optional if you are using the above Lambda function):" class="md-nav__link">
    Manual Setup Actions (optional if you are using the above Lambda function):
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-the-history-schema" title="Creating the HISTORY Schema:" class="md-nav__link">
    Creating the HISTORY Schema:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-the-history-tables" title="Creating the History Tables:" class="md-nav__link">
    Creating the History Tables:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-the-views-to-join-the-historical-and-current-information" title="Creating the Views to Join the Historical and Current Information:" class="md-nav__link">
    Creating the Views to Join the Historical and Current Information:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#populating-the-history-tables" title="Populating the History Tables:" class="md-nav__link">
    Populating the History Tables:
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#querying-the-views-in-the-history-schema" title="Querying the Views in the History Schema:" class="md-nav__link">
    Querying the Views in the History Schema:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#long-term-archival-of-system-table-data" title="Long term archival of System Table data" class="md-nav__link">
    Long term archival of System Table data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#other-considerations" title="Other Considerations:" class="md-nav__link">
    Other Considerations:
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../second_level/" title="Second Level" class="md-nav__link">
      Second Level
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3">
    
    <label class="md-nav__link" for="nav-3">
      Cheat Sheets
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Cheat Sheets
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3-1" type="checkbox" id="nav-3-1">
    
    <label class="md-nav__link" for="nav-3-1">
      Big Data
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-3-1">
        Big Data
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../cheetsheets/bigdata/hadoop_chtsht/" title="Hadoop" class="md-nav__link">
      Hadoop
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../cheetsheets/bigdata/pig_chtsht/" title="PIG" class="md-nav__link">
      PIG
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../cheetsheets/bigdata/htrn_chtsht/" title="Hortron" class="md-nav__link">
      Hortron
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../cheetsheets/bigdata/casestudies/" title="Case Studies" class="md-nav__link">
      Case Studies
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4" type="checkbox" id="nav-4">
    
    <label class="md-nav__link" for="nav-4">
      Tutorials
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-4">
        Tutorials
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-4-1" type="checkbox" id="nav-4-1">
    
    <label class="md-nav__link" for="nav-4-1">
      Redshift
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-4-1">
        Redshift
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../tutorial/redshift/rsintrodwaws/" title="Introduction to Data Warehouse in AWS" class="md-nav__link">
      Introduction to Data Warehouse in AWS
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../tutorial/redshift/rsmoderndwaws/" title="Modernize Your Data Warehouse in AWS" class="md-nav__link">
      Modernize Your Data Warehouse in AWS
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
      
      
      


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5" type="checkbox" id="nav-5">
    
    <label class="md-nav__link" for="nav-5">
      Events
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-5">
        Events
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-5-1" type="checkbox" id="nav-5-1">
    
    <label class="md-nav__link" for="nav-5-1">
      AWS
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="2">
      <label class="md-nav__title" for="nav-5-1">
        AWS
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../../../event/reinvent/awsri_2018/" title="re-Invent 2018" class="md-nav__link">
      re-Invent 2018
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../../../event/reinvent/awsri_2019/" title="re-Invent 2019" class="md-nav__link">
      re-Invent 2019
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">


   <div class="a2a_kit">
       <a id="fblike" class="a2a_button_facebook_like" data-action="recommend" data-href="https://kawishsiddiqui.com/" data-layout="box_count" data-width="55"></a>
   </div>
   <script async src="https://static.addtoany.com/menu/page.js"></script>



      
            <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
            <!-- kawishsiddiqui TOC -->
            <ins class="adsbygoogle"
                 style="border:none;display:inline-block;width:200px;height:100px"
                 data-ad-client="ca-pub-5546856204176740"
                 data-ad-slot="1250189729"
			 > </ins>
            <script>
                 (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
      

  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#deploying" title="Deploying" class="md-nav__link">
    Deploying
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#manual-setup-actions-optional-if-you-are-using-the-above-lambda-function" title="Manual Setup Actions (optional if you are using the above Lambda function):" class="md-nav__link">
    Manual Setup Actions (optional if you are using the above Lambda function):
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-the-history-schema" title="Creating the HISTORY Schema:" class="md-nav__link">
    Creating the HISTORY Schema:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-the-history-tables" title="Creating the History Tables:" class="md-nav__link">
    Creating the History Tables:
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#creating-the-views-to-join-the-historical-and-current-information" title="Creating the Views to Join the Historical and Current Information:" class="md-nav__link">
    Creating the Views to Join the Historical and Current Information:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#populating-the-history-tables" title="Populating the History Tables:" class="md-nav__link">
    Populating the History Tables:
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#querying-the-views-in-the-history-schema" title="Querying the Views in the History Schema:" class="md-nav__link">
    Querying the Views in the History Schema:
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#long-term-archival-of-system-table-data" title="Long term archival of System Table data" class="md-nav__link">
    Long term archival of System Table data
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#other-considerations" title="Other Considerations:" class="md-nav__link">
    Other Considerations:
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
				<!-- BEGIN Ad -->
				
				      
				<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
				<ins class="adsbygoogle"
				     style="display:block;height:100px"
				     data-ad-layout="in-article"
				     data-ad-format="fluid"
				     data-ad-client="ca-pub-5546856204176740"
				     data-ad-slot="5536919095"></ins>
				<script>
				     (adsbygoogle = window.adsbygoogle || []).push({});
				</script>
				      
				
				<!-- END Ad -->
				
                <div class="admonition important">
<p class="admonition-title">Disclaimer:</p>
<p><div id="disclaimer"> </div>
<p id="credit"></p></p>
</div>
<script>
    var git_user = "awslabs";
    var git_tree = ""
    var git_repo_name = "SystemTablePersistence";
    var git_repo_path = git_user + "/amazon-redshift-utils/tree/master/src/SystemTablePersistence";
//
// Disclaimer Code
    var disc_line = "<i>Information on this page is based on the article published by ";
    disc_line = disc_line + "<a href='https://github.com/" + git_user + "'>" + git_user + "</a>"
    disc_line = disc_line + " at ";
    disc_line = disc_line + " <a href='https://github.com/" + git_repo_path + "'>" + git_repo_name + "</a> ";
    disc_line = disc_line + " and not owned or represented by [";
    disc_line = disc_line + "<a href='https://" + window.location.hostname +"'>" + window.location.hostname + "</a> ] ";
    disc_line = disc_line + "or this article is true and accurate to the best of the authors' knowledge. ";
    disc_line = disc_line + "Information on this site should be verified and tested before usage at your own effort and risk and <b>should not be considered as Official sources by any mean through this website.<b></i>";
    document.getElementById("disclaimer").innerHTML = disc_line;    
 </script>

<hr />
<h1 id="amazon-redshift-system-object-persistence-utility">Amazon Redshift System Object Persistence Utility</h1>
<p>Amazon Redshift, like most databases, contains monitoring and diagnostic information in the form of internal tables and views that can be queried to understand system behaviour better. Redshift system tables and views, numbering over 100, have a system-controlled retention that is variable but tends to be less than a week for common Redshift use-cases.</p>
<p>This <a href="https://docs.aws.amazon.com/redshift/latest/dg/c_types-of-system-tables-and-views.html">link</a> outlines the most important tables and views for diagnostic performance information.</p>
<ul>
<li>The <strong>stl_</strong> prefix denotes system table logs. stl_ tables contain logs about operations that happened on the cluster in the past few days.</li>
<li>The <strong>stv_</strong> prefix denotes system table snapshots. stv_ tables contain a snapshot of the current state of the cluster.</li>
<li>The <strong>svl_</strong> prefix denotes system view logs. svl_ views join some number of system tables to provide more descriptive info.</li>
<li>The <strong>svv_</strong> prefix denotes system view snapshots. Like the svl_ views, the svv_ views join some system tables to provide more descriptive info.</li>
</ul>
<p>To persist the tables for a longer amount of time, this project provides an example implementation to create, populate, and use five of the most common objects that we see requiring long term retention. This mix of tables and views will highlight some of the edge cases users will encounter when applying tuning techniques techniques to their own list of tables.</p>
<h2 id="deploying">Deploying</h2>
<p>The <a href="https://github.com/awslabs/amazon-redshift-utils/tree/master/src/RedshiftAutomation">Redshift Automation project</a> can be used to host and run this utility, plus others including table analysis and vacuum, and can be setup with a one-click deployment to AWS Lambda. </p>
<p>We have provided the following AWS SAM templates so that you can deploy this function as stand-alone, without the other functions from the wider RedshiftAutomation modules (please note that we currently only support deploying into VPC):</p>
<table>
<thead>
<tr>
<th>Region</th>
<th>Template</th>
</tr>
</thead>
<tbody>
<tr>
<td>ap-northeast-1</td>
<td><a href="https://console.aws.amazon.com/cloudformation/home?region=ap-northeast-1#/stacks/new?stackName=RedshiftAutomationSystemTablePersistence&amp;templateURL=https://s3-ap-northeast-1.amazonaws.com/awslabs-code-ap-northeast-1/LambdaRedshiftRunner/deploy-systable-standalone.yaml"><img src="https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png"></a></td>
</tr>
<tr>
<td>ap-northeast-2</td>
<td><a href="https://console.aws.amazon.com/cloudformation/home?region=ap-northeast-2#/stacks/new?stackName=RedshiftAutomationSystemTablePersistence&amp;templateURL=https://s3-ap-northeast-2.amazonaws.com/awslabs-code-ap-northeast-2/LambdaRedshiftRunner/deploy-systable-standalone.yaml"><img src="https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png"></a></td>
</tr>
<tr>
<td>ap-south-1</td>
<td><a href="https://console.aws.amazon.com/cloudformation/home?region=ap-south-1#/stacks/new?stackName=RedshiftAutomationSystemTablePersistence&amp;templateURL=https://s3-ap-south-1.amazonaws.com/awslabs-code-ap-south-1/LambdaRedshiftRunner/deploy-systable-standalone.yaml"><img src="https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png"></a></td>
</tr>
<tr>
<td>ap-southeast-1</td>
<td><a href="https://console.aws.amazon.com/cloudformation/home?region=ap-southeast-1#/stacks/new?stackName=RedshiftAutomationSystemTablePersistence&amp;templateURL=https://s3-ap-southeast-1.amazonaws.com/awslabs-code-ap-southeast-1/LambdaRedshiftRunner/deploy-systable-standalone.yaml"><img src="https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png"></a></td>
</tr>
<tr>
<td>ap-southeast-2</td>
<td><a href="https://console.aws.amazon.com/cloudformation/home?region=ap-southeast-2#/stacks/new?stackName=RedshiftAutomationSystemTablePersistence&amp;templateURL=https://s3-ap-southeast-2.amazonaws.com/awslabs-code-ap-southeast-2/LambdaRedshiftRunner/deploy-systable-standalone.yaml"><img src="https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png"></a></td>
</tr>
<tr>
<td>ca-central-1</td>
<td><a href="https://console.aws.amazon.com/cloudformation/home?region=ca-central-1#/stacks/new?stackName=RedshiftAutomationSystemTablePersistence&amp;templateURL=https://s3-ca-central-1.amazonaws.com/awslabs-code-ca-central-1/LambdaRedshiftRunner/deploy-systable-standalone.yaml"><img src="https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png"></a></td>
</tr>
<tr>
<td>eu-central-1</td>
<td><a href="https://console.aws.amazon.com/cloudformation/home?region=eu-central-1#/stacks/new?stackName=RedshiftAutomationSystemTablePersistence&amp;templateURL=https://s3-eu-central-1.amazonaws.com/awslabs-code-eu-central-1/LambdaRedshiftRunner/deploy-systable-standalone.yaml"><img src="https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png"></a></td>
</tr>
<tr>
<td>eu-west-1</td>
<td><a href="https://console.aws.amazon.com/cloudformation/home?region=eu-west-1#/stacks/new?stackName=RedshiftAutomationSystemTablePersistence&amp;templateURL=https://s3-eu-west-1.amazonaws.com/awslabs-code-eu-west-1/LambdaRedshiftRunner/deploy-systable-standalone.yaml"><img src="https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png"></a></td>
</tr>
<tr>
<td>eu-west-2</td>
<td><a href="https://console.aws.amazon.com/cloudformation/home?region=eu-west-2#/stacks/new?stackName=RedshiftAutomationSystemTablePersistence&amp;templateURL=https://s3-eu-west-2.amazonaws.com/awslabs-code-eu-west-2/LambdaRedshiftRunner/deploy-systable-standalone.yaml"><img src="https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png"></a></td>
</tr>
<tr>
<td>sa-east-1</td>
<td><a href="https://console.aws.amazon.com/cloudformation/home?region=sa-east-1#/stacks/new?stackName=RedshiftAutomationSystemTablePersistence&amp;templateURL=https://s3-sa-east-1.amazonaws.com/awslabs-code-sa-east-1/LambdaRedshiftRunner/deploy-systable-standalone.yaml"><img src="https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png"></a></td>
</tr>
<tr>
<td>us-east-1</td>
<td><a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-1#/stacks/new?stackName=RedshiftAutomationSystemTablePersistence&amp;templateURL=https://s3.amazonaws.com/awslabs-code-us-east-1/LambdaRedshiftRunner/deploy-systable-standalone.yaml"><img src="https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png"></a></td>
</tr>
<tr>
<td>us-east-2</td>
<td><a href="https://console.aws.amazon.com/cloudformation/home?region=us-east-2#/stacks/new?stackName=RedshiftAutomationSystemTablePersistence&amp;templateURL=https://s3-us-east-2.amazonaws.com/awslabs-code-us-east-2/LambdaRedshiftRunner/deploy-systable-standalone.yaml"><img src="https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png"></a></td>
</tr>
<tr>
<td>us-west-1</td>
<td><a href="https://console.aws.amazon.com/cloudformation/home?region=us-west-1#/stacks/new?stackName=RedshiftAutomationSystemTablePersistence&amp;templateURL=https://s3-us-west-1.amazonaws.com/awslabs-code-us-west-1/LambdaRedshiftRunner/deploy-systable-standalone.yaml"><img src="https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png"></a></td>
</tr>
<tr>
<td>us-west-2</td>
<td><a href="https://console.aws.amazon.com/cloudformation/home?region=us-west-2#/stacks/new?stackName=RedshiftAutomationSystemTablePersistence&amp;templateURL=https://s3-us-west-2.amazonaws.com/awslabs-code-us-west-2/LambdaRedshiftRunner/deploy-systable-standalone.yaml"><img src="https://s3.amazonaws.com/cloudformation-examples/cloudformation-launch-stack.png"></a></td>
</tr>
</tbody>
</table>
<p>We’ve also run across some customers who already have an EC2 host for cron/scheduling related activities. If you wish to use ec2 or other runners with cron, then the Redshift Automation command line provides an option to run this application:</p>
<pre><code>./ra --utility SystemTablePersistence --config s3://mybucket/prefix/config.json
</code></pre>

<h2 id="manual-setup-actions-optional-if-you-are-using-the-above-lambda-function">Manual Setup Actions (optional if you are using the above Lambda function):</h2>
<h3 id="creating-the-history-schema">Creating the HISTORY Schema:</h3>
<p>Creating a separate schema is a convenient way to sequester the history tables and views away from other objects. Any preferred schema name can be used; a case-insensitive search-and-replace of &ldquo;HISTORY&rdquo; will correctly update all the schema references in the included SQL.</p>
<pre><code>CREATE SCHEMA IF NOT EXISTS history;
</code></pre>

<h3 id="creating-the-history-tables">Creating the History Tables:</h3>
<p>The persisted data will be stored in direct-attached storage tables in Redshift. For the tables, the <code>CREATE TABLE {tablename} LIKE</code> technique is an easy way to inherit the column names, datatypes, encoding, and table distribution from system tables. For system views, an Internet search on the view name (for example: <code>SVL_QUERY_SUMMARY</code>) will direct the user to the Redshift documentation which includes the column-level description. This table will frequently copy-and-paste well into a spreadsheet program, allow for easy extraction of the column name and data type information.</p>
<p>History tables are created in the <code>HISTORY</code> schema, and will be verified on each run of the table persistence system. You can view the table creation statements in <a href="https://raw.githubusercontent.com/awslabs/amazon-redshift-utils/master/src/SystemTablePersistence/lib/history_table_creation.sql"><code>history_table_creation.sql</code></a>.</p>
<h3 id="creating-the-views-to-join-the-historical-and-current-information">Creating the Views to Join the Historical and Current Information:</h3>
<p>The views return data from both the current system objects and the historical tables. The anti-join pattern is used to accomplish the deduplication of rows.</p>
<pre><code>CREATE OR REPLACE VIEW history.all_stl_load_errors AS
(
SELECT le.*  FROM stl_load_errors le
UNION ALL
SELECT h.* FROM stl_load_errors le
RIGHT OUTER JOIN history.hist_stl_load_errors h ON (le.query = h.query AND le.starttime = h.starttime)
WHERE le.query IS NULL
);

CREATE OR REPLACE VIEW history.all_stl_query AS
(
SELECT q.* FROM stl_query q
UNION ALL
SELECT h.* FROM stl_query q
RIGHT OUTER JOIN history.hist_stl_query h ON (q.query = h.query AND q.starttime = h.starttime)
WHERE q.query IS NULL
);

CREATE OR REPLACE VIEW history.all_stl_wlm_query AS
(
SELECT wq.* FROM stl_wlm_query wq
UNION ALL
SELECT h.* FROM stl_wlm_query wq
RIGHT OUTER JOIN history.hist_stl_wlm_query h ON (wq.query = h.query AND wq.service_class_start_time = h.service_class_start_time)
WHERE wq.query IS NULL
);

CREATE OR REPLACE VIEW history.all_stl_explain AS
(
SELECT e.* FROM stl_explain e
UNION ALL
SELECT h.* FROM stl_explain e
RIGHT OUTER JOIN history.hist_stl_explain h ON (e.query = h.query AND e.userid = h.userid AND e.nodeid = h.nodeid AND e.parentid = h.parentid AND e.plannode = h.plannode)
WHERE e.query IS NULL
);

CREATE OR REPLACE VIEW history.all_svl_query_summary AS
(
SELECT qs.* FROM svl_query_summary qs
UNION ALL
SELECT h.* FROM svl_query_summary qs
RIGHT OUTER JOIN history.hist_svl_query_summary h ON (qs.query = h.query AND qs.userid = h.userid AND qs.stm = h.stm AND qs.seg = h.seg AND qs.step = h.step AND qs.maxtime = h.maxtime AND qs.label = h.label)
WHERE qs.query IS NULL
);
</code></pre>

<h2 id="populating-the-history-tables">Populating the History Tables:</h2>
<p>This can be done Daily or on a User-Selected Frequency (we recommend populating the history tables daily).</p>
<p>This utility will insert only the new rows using the model as described above, with an anti-join:</p>
<pre><code>INSERT INTO history.hist_stl_load_errors (
  SELECT le.* FROM stl_load_errors le, (SELECT NVL(MAX(starttime),'01/01/1902'::TIMESTAMP) AS max_starttime FROM history.hist_stl_load_errors) h WHERE le.starttime &gt; h.max_starttime);
</code></pre>

<p>You can view the statements that will be run by the utility in <a href="https://raw.githubusercontent.com/awslabs/amazon-redshift-utils/master/src/SystemTablePersistence/lib/history_table_config.json"><code>history_table_config.json</code></a>;</p>
<h3 id="querying-the-views-in-the-history-schema">Querying the Views in the History Schema:</h3>
<p>The history schema views can be queried in exactly the same way that users have interacted with the existing system objects.</p>
<pre><code>SELECT * FROM history.all_stl_load_errors WHERE UPPER(err_reason) LIKE '%DELIMITER NOT FOUND%';
SELECT * FROM history.all_stl_query WHERE query = 1121;
SELECT COUNT(*) FROM history.all_stl_wlm_query WHERE service_class = 6;
SELECT * FROM history.all_stl_explain WHERE query = 1121 ORDER BY nodeid;
SELECT * FROM history.all_svl_query_summary WHERE bytes &gt; 1000000;
</code></pre>

<h2 id="long-term-archival-of-system-table-data">Long term archival of System Table data</h2>
<p>If required, this utility can archive data from the internal HISTORY tables to Amazon S3. Add the following configuration values to your configuration file:</p>
<pre><code>&quot;s3_unload_location&quot;:&quot;s3://mybucket/prefix/redshift/systables/archive&quot;
&quot;s3_unload_role_arn&quot;:&quot;arn:aws:iam::&lt;acct&gt;:role/&lt;role name&gt;&quot;
</code></pre>

<p>Please note that the <code>s3_unload_role_arn</code> should be linked to the Redshift cluster to enable S3 access <a href="https://docs.aws.amazon.com/redshift/latest/mgmt/copy-unload-iam-role.html">as outlined here</a>.</p>
<p>The structure of the exported data will make it suitable for querying via the AWS Glue Data Catalog. Both the cluster-name and the datetime of data export will be configured as partitions. The structure of the data in the exported location will be:</p>
<ul>
<li><code>Configured output location</code><ul>
<li><code>&lt;table name&gt;</code> - such as <code>hist_svl_query_summary</code>, <code>hist_stl_explain</code><ul>
<li><code>cluster=&lt;your cluster name&gt;</code><ul>
<li><code>datetime=&lt;exported date time information&gt;</code></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>For example: 
<img alt="image" src="https://github.com/awslabs/amazon-redshift-utils/raw/master/src/SystemTablePersistence/exported_s3_structure.png" /></p>
<p>All exported data is quoted, compressed csv data.</p>
<h2 id="other-considerations">Other Considerations:</h2>
<p>As with any table in Redshift, it&rsquo;s a best practice to analyze (even just a handful of columns) on a weekly basis. This will help inform the query planner of the attributes of the table. Users may also want to enhance the performance of the history views by adding sort keys to the underlying history tables. It is recommended to consider columns used in the filter condition on the associated view for good sort key candidates.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">

					   


  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
        [ &copy; <script> document.write("<a href='" + window.location.href +"'>" + window.location.hostname + "</a> ] "); </script>
        
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../../assets/fonts/font-awesome.css">
    
      <a href="https://github.com/ksiddiqui79" class="md-footer-social__link fa fa-github"></a>
    
      <a href="https://twitter.com/iamkawish" class="md-footer-social__link fa fa-twitter"></a>
    
      <a href="https://linkedin.com/in/kawish" class="md-footer-social__link fa fa-linkedin"></a>
    
  <img src="https://smallseotools.com/counterDisplay?code=ab8260dea84197452b9dfab712d575f6&style=0003&pad=8&type=page&initCount=620" alt="counter for traffic" width="100" height="15" border="0">
	
  </div>

	  
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../../assets/javascripts/application.245445c6.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../../.."}})</script>
      
    

<div class="a2a_kit a2a_floating_style a2a_vertical_style" style="right:20px; bottom:20px;">
    <a class="a2a_button_facebook"></a>
    <a class="a2a_button_twitter"></a>
    <a class="a2a_button_linkedin"></a>
    <a class="a2a_button_whatsapp"></a>
    <a class="a2a_button_email"></a>
    <a class="a2a_dd" href="https://www.addtoany.com/share"></a>
</div>

<script async src="https://static.addtoany.com/menu/page.js"></script>
  </body>
</html>