<!DOCTYPE html>
<html>

<head>
    <!-- BEGIN Kawish's Custom metadata block -->
<!-- Google AdSense -->

      
        <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<script>
  (adsbygoogle = window.adsbygoogle || []).push({
    google_ad_client: "ca-pub-5546856204176740",
    enable_page_level_ads: true
  });
</script>
      

<!-- Google Analytics -->

	  
        
    <script>
    (function(i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function() {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
        m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
   
    ga('create', 'UA-143819065-1', 'kawishsiddiqui.com');
    ga('send', 'pageview');
    </script>
	  

<!-- Metadata -->

    <!-- meta description -->
    
     <meta name="description" content="Encryption & Decryption UDF in Amazon Redshift">
    
	
    <!-- meta author -->
    
    <!-- meta keywords -->
    
     <meta name="keywords" content="encrypt, decryption, decrypt, encryption, udf, amazon, function, utility, vacuum, analyze, data lake, datalake, formation, case study, shell, bash, sh, split, size, console, aws, files, tips, cheat, shell command, bash command, script, shell script, sql, teradata, redshift, vba, database, data warehouse, etl, custom, big data">
    

    
    <meta name="robots" content="index, follow">	


      
        <title>Encryption & Decryption UDF in Amazon Redshift</title>
      

<!-- END Kawish's Custom metadata block -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <link rel="shortcut icon" href="../..">
    <link rel="../../img/favicon.png">


    <link rel="stylesheet" href="//use.fontawesome.com/releases/v5.5.0/css/all.css" integrity="sha384-B4dIYHKNBt8Bc12p+WXckhzcICo0wtJAoU8YZTY5qE0Id1GSseTk6S+L3BlXeVIU" crossorigin="anonymous">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hack-font@3.3.0/build/web/hack.min.css">
    <link href='//fonts.googleapis.com/css?family=PT+Sans:400,400italic,700,700italic&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href='//fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,700italic,400,300,600,700&subset=latin-ext,latin' rel='stylesheet' type='text/css'>
    <link href="../../css/bootstrap-custom.min.css" rel="stylesheet">
    <link href="../../css/base.min.css" rel="stylesheet">
    <link href="../../css/cinder.min.css" rel="stylesheet">
    <link href="../../css/highlight.min.css" rel="stylesheet">

    <!-- HTML5 shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
            <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
        <![endif]-->

    <script src="//ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js"></script>
    <script>
    WebFont.load({
        google: {
            families: ['Open Sans', 'PT Sans']
        }
    });
    </script>


     
</head>

<body>

    <div class="navbar navbar-default navbar-fixed-top" role="navigation">
    <div class="container">

        <!-- Collapsed navigation -->
        <div class="navbar-header">
            <!-- Expander button -->
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="sr-only">Toggle navigation</span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
                <span class="icon-bar"></span>
            </button>
            

            <!-- Main title -->

            <!-- <a class="navbar-brand" href="../..">Kawish Siddiqui</a>   -->
            <a class="navbar-brand" href="../.."><div id="sitename"></div><script> document.getElementById("sitename").innerHTML = window.location.hostname </script></a>
        </div>

        <!-- Expanded navigation -->
        <div class="navbar-collapse collapse">
                <!-- Main navigation -->
                <ul class="nav navbar-nav">
                
                
                    <li >
                        <a href="../..">About Me</a>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Shell/Bash <b class="caret"></b></a>
						<ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../sh/split_datafile/">Split data file</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">VBA <b class="caret"></b></a>
						<ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../vba/vba_concatif/">ConcatIF Function</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Teradata <b class="caret"></b></a>
						<ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../teradata/td_date_diff/">Date Diff Function</a>
</li>

                        
                            
<li >
    <a href="../../teradata/td_turnoff_fallback/">Turn off FallBackSetting in Teradata</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">AWS <b class="caret"></b></a>
						<ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../aws/dl_form_aws/">DataLake Formation in AWS</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown active">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Redshift <b class="caret"></b></a>
						<ul class="dropdown-menu">
                        
                            
<li class="active">
    <a href="./">Redshift Encryption UDF</a>
</li>

                        
                            
<li >
    <a href="../RedshiftQMRActvtMon/">Redshift QMR Notification Utility</a>
</li>

                        
                            
<li >
    <a href="../Vacclyze/">Redshift Vacuum Analyze</a>
</li>

                        
                            
<li >
    <a href="../awslabs_SystemTablePersistence/">System Table Persistence</a>
</li>

                        
                            
<li >
    <a href="../../second_level/">Second Level</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Cheat Sheets <b class="caret"></b></a>
						<ul class="dropdown-menu">
                        
                            
 
    <li class="dropdown-submenu"> 
    <a tabindex="-1" href="">Big Data</a>

<!--
    <li class="dropdown">
		<a tabindex="-1" href="" class="dropdown-toggle" data-toggle="dropdown">Big Data <b class="caret"></b></a>
-->
    <ul class="dropdown-menu">
        
            
<li >
    <a href="../../cheetsheets/bigdata/hadoop_chtsht/">Hadoop</a>
</li>

        
            
<li >
    <a href="../../cheetsheets/bigdata/pig_chtsht/">PIG</a>
</li>

        
            
<li >
    <a href="../../cheetsheets/bigdata/htrn_chtsht/">Hortron</a>
</li>

        
            
<li >
    <a href="../../cheetsheets/bigdata/casestudies/">Case Studies</a>
</li>

        
    </ul>
  </li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Tutorials <b class="caret"></b></a>
						<ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../tutorial/rs_aod/">Redshift</a>
</li>

                        
                        </ul>
                    </li>
                
                
                
                    <li class="dropdown">
                        <a href="#" class="dropdown-toggle" data-toggle="dropdown">Events <b class="caret"></b></a>
						<ul class="dropdown-menu">
                        
                            
<li >
    <a href="../../event/reinvent/awsri_2018.md">AWS re-Invent 2018</a>
</li>

                        
                        </ul>
                    </li>
                
                
                </ul>

            <ul class="nav navbar-nav navbar-right">
                    <li>
                        <a href="#" data-toggle="modal" data-target="#mkdocs_search_modal">
                            <i class="fas fa-search"></i> Search
                        </a>
                    </li>
                    
					   
					
				<img class="navbar-brand" src="http://www.cutercounter.com/hit.php?id=gqfcck&nd=8&style=148" alt="free counter" border="0"> 
				<!-- Start of CuterCounter Code -->
				
            </ul>
        </div>
    </div>
</div>
   <div class="container">
        
        
        <div class="col-md-3"><div id="toc" class="bs-sidebar hidden-print affix well" role="complementary" overflow="auto">
<!-- BEGIN Ad -->

<script async src='https://cse.google.com/cse.js?cx=partner-pub-5546856204176740:2677115170'></script><div class="gcse-searchbox-only"></div>
      
            <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
            <!-- kawishsiddiqui TOC -->
            <ins class="adsbygoogle"
                 style="border:none;display:inline-block;width:250px;height:150px"
                 data-ad-client="ca-pub-5546856204176740"
                 data-ad-slot="1250189729"
			 > </ins>
            <script>
                 (adsbygoogle = window.adsbygoogle || []).push({});
            </script>
      

<!-- END Ad -->
    <ul class="nav bs-sidenav">
        <li class="first-level active"><a href="#encryption-decryption-udf-in-amazon-redshift">Encryption &amp; Decryption UDF in Amazon Redshift</a></li>
            <li class="second-level"><a href="#amazon-redshift-udf-support">Amazon Redshift UDF Support</a></li>
                
            <li class="second-level"><a href="#encryption-and-decryption-udf">Encryption and Decryption UDF</a></li>
                
        <li class="first-level "><a href="#deployment">Deployment</a></li>
            <li class="second-level"><a href="#create-library">Create library</a></li>
                
            <li class="second-level"><a href="#create-encrypt-function">Create encrypt function</a></li>
                
            <li class="second-level"><a href="#create-decrypt-function">Create decrypt function</a></li>
                
            <li class="second-level"><a href="#test-function-with-same-key-for-encrypt-and-decrypt">Test function with same key for encrypt and decrypt</a></li>
                
            <li class="second-level"><a href="#test-function-with-same-key-for-encrypt-but-different-key-to-decrypt">Test function with same key for encrypt but different key to decrypt</a></li>
                
                <li class="third-level"><a href="#check-for-error-details-if-error-occured">Check for error details if error occured</a></li>
    </ul>
</div>

<div class="a2a_kit a2a_kit_size_32 a2a_floating_style a2a_horizontal_style" style="right:20px; bottom:20px;">
    <a class="a2a_button_facebook"></a>
    <a class="a2a_button_twitter"></a>
    <a class="a2a_button_linkedin"></a>
    <a class="a2a_button_whatsapp"></a>
    <a class="a2a_button_email"></a>
    <a class="a2a_dd" href="https://www.addtoany.com/share"></a>
</div>

<script async src="https://static.addtoany.com/menu/page.js"></script>
<script>
	var toc_h = document.getElementById("toc").style.height; // $("#toc").height();
	document.getElementById("share").style.top = toc_h + "px";
</script></div>
        <div class="col-md-9" role="main"><!-- BEGIN Ad -->

      
<script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
<ins class="adsbygoogle"
     style="display:block;height:150px"
     data-ad-layout="in-article"
     data-ad-format="fluid"
     data-ad-client="ca-pub-5546856204176740"
     data-ad-slot="5536919095"></ins>
<script>
     (adsbygoogle = window.adsbygoogle || []).push({});
</script>
      

<!-- END Ad -->




<h1 id="encryption-decryption-udf-in-amazon-redshift">Encryption &amp; Decryption UDF in Amazon Redshift</h1>
<h2 id="amazon-redshift-udf-support">Amazon Redshift UDF Support</h2>
<p>Amazon Redshift supports <a href="https://docs.aws.amazon.com/redshift/latest/dg/user-defined-functions.html">User Defined Fuction</a> using SQL or Python.</p>
<h2 id="encryption-and-decryption-udf">Encryption and Decryption UDF</h2>
<p>This function uses <code>pyaes</code> module to encrypt data using AES <code>encrypt</code> and <code>decrypt</code> functions.<br />
<strong>AED encryption needs atleast 16 character key to encrypt data, key length less than 16 characters may throw error.</strong></p>
<h1 id="deployment">Deployment</h1>
<h2 id="create-library">Create library</h2>
<pre><code class="SQL">CREATE OR REPLACE LIBRARY pyaes  
LANGUAGE plpythonu  
FROM 'https://github.com/ksiddiqui79/redshift_udfs/blob/master/encrypt_decrypt_udf/using_pyaes/pyaes.zip?raw=true'  
;  
</code></pre>

<h2 id="create-encrypt-function">Create encrypt function</h2>
<pre><code class="SQL">CREATE OR REPLACE FUNCTION aes_encrypt(input VARCHAR(max), vKey VARCHAR(256))  
RETURNS VARCHAR STABLE AS $$  
  import pyaes  
  import binascii  
  if input is None:  
    return None  
  key = vKey # Your Key here  
  aes=pyaes.AESModeOfOperationCTR(key)  
  cipher_txt=aes.encrypt(input)  
  cipher_txt2=binascii.hexlify(cipher_txt)  
  return str(cipher_txt2.decode('utf-8'))  
$$ LANGUAGE plpythonu  
;  
</code></pre>

<h2 id="create-decrypt-function">Create decrypt function</h2>
<pre><code class="SQL">CREATE OR REPLACE FUNCTION aes_decrypt(encrypted_msg varchar(max), vKey VARCHAR(256))  
RETURNS VARCHAR STABLE AS $$  
  import pyaes  
  import binascii  
  if encrypted_msg is None or len(str(encrypted_msg)) == 0:  
       return None  
  key = vKey # Your decryption key here  
  aes = pyaes.AESModeOfOperationCTR(key)  
  encrypted_msg2=binascii.unhexlify(encrypted_msg)  
  decrypted_msg2 = aes.decrypt(encrypted_msg2)  
  return str(decrypted_msg2.decode('utf-8'))  
$$ LANGUAGE plpythonu ;  
</code></pre>

<h2 id="test-function-with-same-key-for-encrypt-and-decrypt">Test function with same key for encrypt and decrypt</h2>
<p><strong>SQL</strong>  </p>
<pre><code class="SQL">SELECT aes_encrypt(myVal, myKey) encdata, aes_decrypt(enc_data, myKey) decdata  
FROM (SELECT 'Kawish Siddiqui' myVal, LPAD(myVal, 16, 'z') myKey) a;  
</code></pre>

<p><strong>Result</strong>  </p>
<table>
<thead>
<tr>
<th>encdata</th>
<th>decdata</th>
</tr>
</thead>
<tbody>
<tr>
<td>9a861c3fc1007a9b50f16ef7e1927d</td>
<td>Kawish Siddiqui</td>
</tr>
</tbody>
</table>
<h2 id="test-function-with-same-key-for-encrypt-but-different-key-to-decrypt">Test function with same key for encrypt but different key to decrypt</h2>
<pre><code class="SQL">SELECT aes_encrypt(myVal, myKey) encdata, aes_decrypt(enc_data, myKey||'x') decdata  
FROM (SELECT 'Kawish Siddiqui' myVal, LPAD(myVal, 16, 'z') myKey) a;  
</code></pre>

<p><strong>Above SQL should throw an error similar to :</strong>  </p>
<pre><code>[Amazon](500310) Invalid operation: ValueError: Invalid key size. Please look at svl_udf_log for more information  
Details:   
 -----------------------------------------------;  
  error:  ValueError: Invalid key size. Please look at svl_udf_log for more information  
  code:      10000  
  context:   UDF  
  query:     0  
  location:  udf_client.cpp:369  
  process:   padbmaster [pid=91425]  
  -----------------------------------------------;  
1 statement failed.  
</code></pre>

<h3 id="check-for-error-details-if-error-occured">Check for error details if error occured</h3>
<pre><code class="SQL">SELECT * FROM svl_udf_log;  
</code></pre></div>
        
        
    </div>

   <footer class="col-md-12 text-center">
 
        <hr>
        <p>
        <small>[ &copy; <script> document.write("<a href='" + window.location.href +"'>" + window.location.hostname + "</a> ] "); </script> <br></small>
		
        

        
        
    </footer>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="../../js/bootstrap-3.0.3.min.js"></script>
    <script src="../../js/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    <script>var base_url = "../.."</script>
    
    <script src="../../js/base.js"></script>
    <script src="../../search/main.js"></script>

    <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
                <p>
                    From here you can search these documents. Enter
                    your search terms below.
                </p>
                <form>
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">&times;</span><span class="sr-only">Close</span></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>
    </body>

</html>
